<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RUN FIT - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --primary:#0a7cff;
      --accent:#00d0ff;
      --card:#ffffff;
      --bg:#f5f7fb;
      --muted:#6b7280;
      --success:#16a34a;
      --danger:#ef4444;
      --glass: rgba(255,255,255,0.7);
    }
    html,body{height:100%;margin:0;font-family:"Cairo",sans-serif;direction:rtl;background:linear-gradient(180deg,#f5f7fb,#eef6ff);}
    /* NAV */
    .navbar{background:var(--primary);color:#fff;padding:14px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 6px 18px rgba(10,124,255,0.18);}
    .navbar .brand{font-weight:700;font-size:20px}
    .nav-links{display:flex;gap:18px;align-items:center}
    .nav-links a{color:white;text-decoration:none;font-weight:600}
    .nav-actions{display:flex;gap:10px}
    .btn{background:var(--primary);color:white;padding:10px 14px;border-radius:10px;text-decoration:none;cursor:pointer;border:none;font-weight:700}
    .btn-ghost{background:transparent;border:2px solid rgba(255,255,255,0.14);padding:8px 12px;border-radius:10px;color:white;cursor:pointer}
    /* HERO */
    .hero{display:flex;align-items:center;justify-content:center;padding:40px 20px;background:linear-gradient(135deg,#0084ff,#00c6ff);color:#fff}
    .hero-card{background:rgba(0,0,0,0.35);padding:30px;border-radius:14px;max-width:900px;text-align:center}
    .hero h1{margin:0 0 8px;font-size:28px}
    .hero p{margin:0 0 12px;opacity:0.95}
    /* LAYOUT */
    .main{max-width:1100px;margin:26px auto;padding:0 16px;display:grid;grid-template-columns:1fr 380px;gap:20px;align-items:start}
    @media(max-width:980px){.main{grid-template-columns:1fr} .right-col{order:2}}
    .card{background:var(--card);padding:20px;border-radius:14px;box-shadow:0 6px 18px rgba(20,30,60,0.06)}
    /* FORM */
    label{display:block;margin-bottom:6px;font-weight:700;color:#0b2a44}
    input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #d1d5db;margin-bottom:12px;font-size:15px}
    .small{font-size:13px;color:var(--muted)}
    .row{display:flex;gap:10px}
    .row .col{flex:1}
    /* result */
    .result{background:#e9f8ff;border-right:6px solid var(--primary);padding:16px;border-radius:10px;margin-top:12px}
    .result b{color:#063970}
    .suggestions{margin-top:12px;background:#fff7ed;border-right:6px solid #ffb020;padding:12px;border-radius:8px}
    /* history & chart */
    #chart{width:100%;height:220px}
    .history-list{max-height:250px;overflow:auto;padding-right:6px}
    .history-item{padding:10px;border-bottom:1px dashed #eef2f7}
    .history-item:last-child{border-bottom:none}
    /* gps canvas */
    .gps-wrap{height:200px;border-radius:10px;overflow:hidden;background:#f8fafc;border:1px solid #e6eef8;display:flex;align-items:center;justify-content:center}
    canvas#gps{width:100%;height:100%}
    /* footer */
    footer{margin-top:22px;text-align:center;padding:18px 8px;color:#fff;background:var(--primary);border-radius:10px;margin-left:16px;margin-right:16px}
    /* modal */
    .modal-back{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:60}
    .modal{background:var(--card);padding:20px;border-radius:10px;max-width:420px;width:92%;box-shadow:0 12px 40px rgba(8,12,40,0.35)}
    .flex{display:flex;gap:10px;align-items:center}
    .badge{background:#f0f9ff;color:#0369a1;padding:6px 10px;border-radius:8px;font-weight:700}
    .muted{color:var(--muted)}
    /* small helpers */
    .mt10{margin-top:10px}.mt20{margin-top:20px}.center{text-align:center}
  </style>
</head>
<body>

  <nav class="navbar">
    <div class="brand">RUN FIT</div>
    <div class="nav-links">
      <a href="#calc">Ø§Ù„Ø­Ø§Ø³Ø¨Ø©</a>
      <a href="#history">Ø§Ù„Ø³Ø¬Ù„</a>
    </div>
    <div class="nav-actions">
      <button class="btn-ghost" id="openLoginBtn">ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„</button>
      <button class="btn" id="openRegisterBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    </div>
  </nav>

  <header class="hero">
    <div class="hero-card">
      <h1>Ø­Ø§Ø³Ø¨Ø© Ø¬Ø±ÙŠ Ø§Ø­ØªØ±Ø§ÙÙŠØ© â€” Ø®Ø·ØªÙƒ Ù„Ù„Ø±Ø´Ø§Ù‚Ø© ØªØ¨Ø¯Ø£ Ù‡Ù†Ø§</h1>
      <p>Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ø­Ø±Ù‚ Ø³Ø¹Ø±Ø§Øª Ù…Ø¹ÙŠÙ†Ø©ØŒ Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ÙˆÙ‚ØªØŒ Ø§Ù„Ù€Ù€PaceØŒ VOâ‚‚ Max ØªÙ‚Ø±ÙŠØ¨ÙŠØŒ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†ØŒ ÙˆØ³Ø¬Ù„ Ù…ØªÙ‚Ø¯Ù… Ù…Ø¹ Ø±Ø³ÙˆÙ…Ø§Øª.</p>
      <div style="margin-top:12px">
        <a href="#calc" class="btn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</a>
      </div>
    </div>
  </header>

  <main class="main">
    <!-- LEFT: Calculator -->
    <section class="card" id="calc">
      <h2>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¬Ø±ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h2>

      <div class="row mt10">
        <div class="col">
          <label>Ø§Ù„Ø¹Ù…Ø±</label>
          <input id="age" type="number" min="10" placeholder="Ù…Ø«Ø§Ù„: 30">
        </div>
        <div class="col">
          <label>Ø§Ù„Ø¬Ù†Ø³</label>
          <select id="gender">
            <option value="male">Ø°ÙƒØ±</option>
            <option value="female">Ø£Ù†Ø«Ù‰</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Ø§Ù„ÙˆØ²Ù† (ÙƒØº)</label>
          <input id="weight" type="number" min="20" placeholder="Ù…Ø«Ø§Ù„: 70">
        </div>
        <div class="col">
          <label>Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)</label>
          <input id="height" type="number" min="100" placeholder="Ù…Ø«Ø§Ù„: 175">
        </div>
      </div>

      <label>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù„ÙŠØ§Ù‚Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <select id="fitnessLevel">
        <option value="1">Ø¶Ø¹ÙŠÙ</option>
        <option value="2" selected>Ù…ØªÙˆØ³Ø·</option>
        <option value="3">Ø¬ÙŠØ¯</option>
        <option value="4">Ù…ØªÙ‚Ø¯Ù…</option>
      </select>

      <div class="row">
        <div class="col">
          <label>Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø±Ù‚Ù‡Ø§ (kcal)</label>
          <input id="calories" type="number" placeholder="Ù…Ø«Ø§Ù„: 300">
        </div>
        <div class="col">
          <label>Ø§Ù„Ø³Ø±Ø¹Ø© (ÙƒÙ…/Ø³Ø§Ø¹Ø©)</label>
          <input id="speed" type="number" placeholder="Ù…Ø«Ø§Ù„: 8">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ©</label>
          <select id="unit">
            <option value="km" selected>ÙƒÙ…</option>
            <option value="mi">Ù…ÙŠÙ„</option>
          </select>
        </div>
        <div class="col">
          <label>ÙˆØ¶Ø¹ Ø§Ù„Ù‡Ø¯Ù (Goal Mode)</label>
          <select id="goalMode">
            <option value="none">Ù„Ø§ Ø´ÙŠØ¡</option>
            <option value="burn">Ø­Ø±Ù‚ Ø³Ø¹Ø±Ø§Øª Ù…Ø­Ø¯Ø¯Ø©</option>
            <option value="distance">Ø§Ù„Ø¬Ø±ÙŠ Ù„Ù…Ø³Ø§ÙØ© Ù…Ø­Ø¯Ø¯Ø©</option>
            <option value="time">Ø§Ù„Ø¬Ø±ÙŠ Ù„Ù…Ø¯Ø© Ù…Ø­Ø¯Ø¯Ø©</option>
          </select>
        </div>
      </div>

      <div id="goalInputs" class="mt10" style="display:none">
        <!-- dynamic by JS -->
      </div>

      <button class="btn mt10" onclick="calculate()">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¢Ù†</button>

      <div id="result" class="result mt10" style="display:none"></div>

      <div id="suggestions" class="suggestions mt10" style="display:none"></div>

      <div class="mt10 small muted">
        ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ø­Ø³Ø§Ø¨Ùƒ ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹. ÙˆØ§Ø¬Ù‡Ø© ØªÙØ§Ø¹Ù„ÙŠØ© ÙˆØ³Ø¬Ù„ ÙŠØ¸Ù‡Ø± Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ù…Ø³Ø§ÙØ§Øª.
      </div>
    </section>

    <!-- RIGHT: Profile / History -->
    <aside class="right-col">
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center">
          <div>
            <div id="profileName"><b>Ø²Ø§Ø¦Ø±</b></div>
            <div class="small muted" id="profileEmail">Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
          </div>
          <div class="badge" id="fitnessBadge">Score: --</div>
        </div>

        <div class="mt10">
          <button class="btn" id="saveRunBtn">Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø­Ø³Ø§Ø¨</button>
          <button class="btn-ghost" id="clearLocalBtn">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ</button>
        </div>

        <div class="mt20">
          <h3 class="small">Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ø³Ø§Ø± GPS</h3>
          <div class="gps-wrap mt10 card" style="padding:8px">
            <canvas id="gps"></canvas>
          </div>
        </div>
      </div>

      <div class="card mt10" id="history">
        <h3>Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨Ø§Øª</h3>
        <canvas id="chart"></canvas>
        <div class="history-list mt10" id="historyBox"></div>
      </div>
    </aside>
  </main>

  <footer>
    Â© 2025 RUN FIT â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© â€” ØªØµÙ…ÙŠÙ… Ø§Ø­ØªØ±Ø§ÙÙŠ ÙˆÙˆØ§Ø¬Ù‡Ø© ØªÙØ§Ø¹Ù„ÙŠØ©
  </footer>

  <!-- modal for register/login -->
  <div class="modal-back" id="modalBack">
    <div class="modal" id="modalContent">
      <div class="center">
        <h3 id="modalTitle">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h3>
        <p class="muted">Ø³Ø¬Ù„ Ø¨Ø­Ø³Ø§Ø¨Ùƒ Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø­Ù…ÙŠØ© ÙˆØ§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø´Ø®ØµÙŠ.</p>
      </div>

      <div id="authForm">
        <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input id="authEmail" type="email" placeholder="you@example.com">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input id="authPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±">
        <div class="row mt10">
          <button class="btn" id="authSubmit">ØªØ³Ø¬ÙŠÙ„</button>
          <button class="btn-ghost" id="authCancel">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
        <div class="mt10 small muted center">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="#" id="switchToLogin">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a></div>
      </div>

      <div id="loginLink" style="display:none"></div>
    </div>
  </div>

<script>
/* -------------------------
  Simple client-side "auth" using localStorage
  Not secure â€” for demo/tracking only.
-------------------------*/
const openRegisterBtn = document.getElementById('openRegisterBtn');
const openLoginBtn = document.getElementById('openLoginBtn');
const modalBack = document.getElementById('modalBack');
const modalTitle = document.getElementById('modalTitle');
const authSubmit = document.getElementById('authSubmit');
const authEmail = document.getElementById('authEmail');
const authPass = document.getElementById('authPass');
const authCancel = document.getElementById('authCancel');
const switchToLogin = document.getElementById('switchToLogin');
const profileName = document.getElementById('profileName');
const profileEmail = document.getElementById('profileEmail');
const fitnessBadge = document.getElementById('fitnessBadge');

let currentUser = JSON.parse(localStorage.getItem('rf_user') || 'null'); // logged-in user object or null
let users = JSON.parse(localStorage.getItem('rf_users') || '{}'); // email -> user object
let runHistory = JSON.parse(localStorage.getItem('rf_history') || '[]'); // global history
let lastCalculation = null;

/* AUTH UI */
function openModal(mode='register'){
  modalBack.style.display='flex';
  if(mode==='register'){
    modalTitle.innerText='ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯';
    authSubmit.innerText='ØªØ³Ø¬ÙŠÙ„';
    switchToLogin.innerText='ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
  } else {
    modalTitle.innerText='ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
    authSubmit.innerText='Ø¯Ø®ÙˆÙ„';
    switchToLogin.innerText='Ù„ÙŠØ³ Ù„Ø¯ÙŠ Ø­Ø³Ø§Ø¨ØŸ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
  }
  authEmail.value=''; authPass.value='';
  modalBack.onclick = (e)=> { if(e.target===modalBack) closeModal(); }
}
function closeModal(){ modalBack.style.display='none' }

openRegisterBtn.addEventListener('click', ()=> openModal('register'));
openLoginBtn.addEventListener('click', ()=> openModal('login'));
switchToLogin.addEventListener('click', (e)=>{
  e.preventDefault();
  // toggle mode
  if(authSubmit.innerText==='ØªØ³Ø¬ÙŠÙ„'){ openModal('login'); } else { openModal('register'); }
});

authCancel.addEventListener('click', closeModal);

authSubmit.addEventListener('click', ()=>{
  const email = authEmail.value.trim().toLowerCase();
  const pass = authPass.value.trim();
  if(!validateEmail(email)){ alert('Ø¨Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ§Ù„Ø­.'); return; }
  if(pass.length < 4){ alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ (Ø£Ù‚Ù„ Ù…Ù† 4 Ø£Ø­Ø±Ù).'); return; }

  if(authSubmit.innerText === 'ØªØ³Ø¬ÙŠÙ„'){ // register
    if(users[email]){ alert('Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ØŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.'); return; }
    users[email] = { email, pass, created: new Date().toISOString(), notes: '', profile:{} };
    localStorage.setItem('rf_users', JSON.stringify(users));
    currentUser = users[email];
    localStorage.setItem('rf_user', JSON.stringify(currentUser));
    updateProfileUI();
    closeModal();
    alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.');
  } else { // login
    if(!users[email] || users[email].pass !== pass){ alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.'); return; }
    currentUser = users[email];
    localStorage.setItem('rf_user', JSON.stringify(currentUser));
    updateProfileUI();
    closeModal();
    alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.');
  }
});

/* PROFILE UI */
function updateProfileUI(){
  if(currentUser){
    profileName.innerHTML = `<b>${currentUser.email.split('@')[0]}</b>`;
    profileEmail.innerText = currentUser.email;
  } else {
    profileName.innerHTML = `<b>Ø²Ø§Ø¦Ø±</b>`;
    profileEmail.innerText = 'Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
  }
}
updateProfileUI();

/* LOGIC: Goal Mode dynamic inputs */
const goalMode = document.getElementById('goalMode');
const goalInputs = document.getElementById('goalInputs');

goalMode.addEventListener('change', ()=>{
  const v = goalMode.value;
  goalInputs.innerHTML = '';
  if(v === 'distance'){
    goalInputs.innerHTML = `<label>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù‡Ø¯Ù (<span id="goalUnitLabel">ÙƒÙ…</span>)</label>
                            <input id="goalDistance" type="number" min="0" placeholder="Ù…Ø«Ø§Ù„: 5">`;
  } else if(v === 'time'){
    goalInputs.innerHTML = `<label>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù‡Ø¯Ù (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)</label>
                            <input id="goalTime" type="number" min="1" placeholder="Ù…Ø«Ø§Ù„: 30">`;
  } else {
    goalInputs.innerHTML = '';
  }
  // ensure label unit follows unit select
  updateGoalUnitLabel();
});

const unitSelect = document.getElementById('unit');
unitSelect.addEventListener('change', updateGoalUnitLabel);
function updateGoalUnitLabel(){
  const lab = document.getElementById('goalUnitLabel');
  if(lab){
    lab.innerText = (unitSelect.value === 'km') ? 'ÙƒÙ…' : 'Ù…ÙŠÙ„';
  }
}

/* CALCULATION */
function calculate(){
  const age = Number(document.getElementById('age').value);
  const gender = document.getElementById('gender').value;
  const weight = Number(document.getElementById('weight').value);
  const height = Number(document.getElementById('height').value);
  const fitnessLevel = Number(document.getElementById('fitnessLevel').value);
  const calories = Number(document.getElementById('calories').value);
  const speed = Number(document.getElementById('speed').value);
  const unit = unitSelect.value;
  const gm = goalMode.value;

  const resultDiv = document.getElementById('result');
  const suggestionsDiv = document.getElementById('suggestions');

  if(!age || !weight || !height || (!calories && gm === 'none') || !speed){
    resultDiv.style.display='block';
    resultDiv.innerHTML = `<b style="color:${'#b45309'}">âš  Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: Ø§Ù„Ø¹Ù…Ø±ØŒ Ø§Ù„ÙˆØ²Ù†ØŒ Ø§Ù„Ø·ÙˆÙ„ØŒ Ø§Ù„Ø³Ø¹Ø±Ø§ØªØŒ Ø§Ù„Ø³Ø±Ø¹Ø©.</b>`;
    suggestionsDiv.style.display='none';
    return;
  }

  // calorie burn estimation:
  // We'll use MET approximation: walking/jogging MET depends on speed.
  // Convert speed (km/h) to m/s and mph for rough MET tables. For simplicity:
  // approximate MET = 3.5 * (speed_kmh / 3)  -> this is a simplification.
  const speedKmh = (unit === 'km') ? speed : speed * 1.60934;
  const met = Math.max(3.0, (speedKmh / 3) * 1.5); // clamp a bit
  // calories burned per minute = (MET * 3.5 * weight_kg) / 200
  const calPerMin = (met * 3.5 * weight) / 200;

  // If user provided target calories (or in goal mode)
  let distanceKm = 0;
  let timeMin = 0;
  if(gm === 'burn' || gm === 'none'){
    // distance estimate: calories / (calPerKm)
    // calPerKm = calPerMin * minutesPerKm ; minutesPerKm = 60 / speedKmh
    const minutesPerKm = 60 / speedKmh;
    const calPerKm = calPerMin * minutesPerKm;
    distanceKm = (calories / calPerKm);
    timeMin = (distanceKm / speedKmh) * 60;
  } else if(gm === 'distance'){
    const gdist = Number(document.getElementById('goalDistance').value || 0);
    if(!gdist){ resultDiv.style.display='block'; resultDiv.innerHTML='âš  Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù‡Ø¯Ù.'; return; }
    const distKm = (unit === 'km') ? gdist : gdist * 1.60934;
    distanceKm = distKm;
    const minutesPerKm = 60 / speedKmh;
    timeMin = distKm * minutesPerKm;
    // calories
    const calPerMinLocal = calPerMin;
    const totalCal = calPerMinLocal * timeMin;
    // override calories variable for storing
    // but keep original for display
  } else if(gm === 'time'){
    const gtime = Number(document.getElementById('goalTime').value || 0);
    if(!gtime){ resultDiv.style.display='block'; resultDiv.innerHTML='âš  Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù‡Ø¯Ù.'; return; }
    timeMin = gtime;
    distanceKm = (speedKmh * timeMin) / 60;
  }

  // Pace = minutes per km
  const paceMinPerKm = 60 / speedKmh;
  // VO2 max approx using Cooper style simple estimate: vo2 = speed(m/min)*0.2 + 3.5
  // convert speed to m/min:
  const speedMMin = (speedKmh * 1000) / 60;
  const vo2 = (speedMMin * 0.2 + 3.5).toFixed(1);

  // Fitness score (simple heuristic)
  // base by VO2 and age
  let fitnessScore = Math.max(0, Math.round((Number(vo2) / (age/30)) * (fitnessLevel/2) * 10));
  if(fitnessScore > 100) fitnessScore = 100;

  // prepare final values with unit conversion
  const distanceDisplay = (unit === 'km') ? distanceKm : (distanceKm / 1.60934);
  const distanceLabel = (unit === 'km') ? 'ÙƒÙ…' : 'Ù…ÙŠÙ„';

  // calories burned final estimate
  const totalCalories = (calPerMin * timeMin).toFixed(0);

  // store lastCalculation
  lastCalculation = {
    ts: new Date().toISOString(),
    age, gender, weight, height, fitnessLevel, unit,
    distanceKm: Number(distanceKm.toFixed(2)),
    distanceDisp: Number(distanceDisplay.toFixed(2)),
    distanceUnit: distanceLabel,
    timeMin: Number(timeMin.toFixed(1)),
    paceMinPerKm: Number(paceMinPerKm.toFixed(2)),
    vo2,
    calories: Number(totalCalories),
    speedKmh: Number(speedKmh.toFixed(2))
  };

  // display
  resultDiv.style.display='block';
  resultDiv.innerHTML = `
    âœ” <b>Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</b> <b>${lastCalculation.distanceDisp} ${lastCalculation.distanceUnit}</b><br>
    âœ” <b>Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹:</b> <b>${lastCalculation.timeMin} Ø¯Ù‚ÙŠÙ‚Ø©</b><br>
    âœ” <b>Ø§Ù„Ù€ Pace:</b> <b>${lastCalculation.paceMinPerKm} Ø¯Ù‚ÙŠÙ‚Ø©/ÙƒÙ…</b><br>
    âœ” <b>VOâ‚‚ Max (ØªÙ‚Ø±ÙŠØ¨ÙŠ):</b> <b>${lastCalculation.vo2}</b><br>
    âœ” <b>ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø±ÙˆÙ‚Ø©:</b> <b>${lastCalculation.calories} kcal</b><br>
    âœ” <b>Ø§Ù„Ø³Ø±Ø¹Ø© (ÙƒÙ…/Ø³Ø§Ø¹Ø©):</b> <b>${lastCalculation.speedKmh} km/h</b>
  `;

  // suggestions
  suggestionsDiv.style.display='block';
  suggestionsDiv.innerHTML = generateSuggestions(lastCalculation);

  // update badge and local history
  fitnessBadge.innerText = `Score: ${fitnessScore}`;
  // push to global runHistory
  runHistory.push(lastCalculation);
  localStorage.setItem('rf_history', JSON.stringify(runHistory));
  renderHistory();
  drawChart();
  drawGPSPath(lastCalculation.distanceKm);
}

/* suggestions helper */
function generateSuggestions(calc){
  let s = `<b>Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†:</b><br><ul>`;
  s += `<li>Ø¥Ø­Ù…Ø§Ø¡ 5-10 Ø¯Ù‚Ø§Ø¦Ù‚ Ù‚Ø¨Ù„ Ø§Ù„Ø¬Ø±ÙŠ.</li>`;
  s += `<li>Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø³ÙˆØ§Ø¦Ù„: Ø§Ø´Ø±Ø¨ ~${Math.max(200, Math.round(calc.calories/20))} Ù…Ù„ Ù…Ù† Ø§Ù„Ù…Ø§Ø¡ Ø¨Ø¹Ø¯ Ø§Ù„Ø¬Ø±ÙŠ.</li>`;
  if(calc.paceMinPerKm < 5) s += `<li>ÙˆØªÙŠØ±ØªÙƒ Ø³Ø±ÙŠØ¹Ø© â€” ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ¨Ø±ÙŠØ¯ ÙˆØ§Ù„Ø´Ø¯ Ø§Ù„Ø¹Ø¶Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¬Ø±ÙŠ.</li>`;
  if(calc.vo2 >= 45) s += `<li>Ù„ÙŠØ§Ù‚ØªÙƒ Ø¬ÙŠØ¯Ø© â€” Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ ØªÙ‚Ø¯Ù… ØªØ¯Ø±ÙŠØ¬ÙŠ.</li>`;
  s += `</ul>`;
  s += `<div class="small muted">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª ØªÙ‚Ø±ÙŠØ¨ÙŠØ© ÙˆØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù…Ø¹Ø§Ø¯Ù„Ø§Øª ØªØ¨Ø³ÙŠØ·ÙŠØ©.</div>`;
  return s;
}

/* HISTORY RENDER */
const historyBox = document.getElementById('historyBox');
function renderHistory(){
  if(!runHistory || runHistory.length===0){
    historyBox.innerHTML = `<div class="small muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯. Ù‚Ù… Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨ Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸.</div>`;
    return;
  }
  let html = '';
  runHistory.slice().reverse().forEach((r, idx) => {
    html += `<div class="history-item">
      <div><b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${new Date(r.ts).toLocaleString()}</div>
      <div>Ù…Ø³Ø§ÙØ©: <b>${(r.distanceKm).toFixed(2)} ÙƒÙ…</b> â€” ÙˆÙ‚Øª: <b>${r.timeMin} Ø¯Ù‚ÙŠÙ‚Ø©</b> â€” ğŸ”¥ <b>${r.calories} kcal</b></div>
    </div>`;
  });
  historyBox.innerHTML = html;
}
renderHistory();

/* Chart */
let chart;
function drawChart(){
  const ctx = document.getElementById('chart').getContext('2d');
  const labels = runHistory.map(r => new Date(r.ts).toLocaleString());
  const data = runHistory.map(r => Number(r.distanceKm));
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)',
        data,
        borderWidth: 3,
        tension:0.3
      }]
    },
    options: {
      scales: { y: { beginAtZero:true } },
      plugins: { legend: { display: false } }
    }
  });
}
drawChart();

/* GPS Simulation: draw simple path proportional to distance */
const gpsCanvas = document.getElementById('gps');
const gpsCtx = gpsCanvas.getContext('2d');
function resizeGPS(){
  const rect = gpsCanvas.getBoundingClientRect();
  gpsCanvas.width = rect.width * devicePixelRatio;
  gpsCanvas.height = rect.height * devicePixelRatio;
  gpsCtx.scale(devicePixelRatio, devicePixelRatio);
}
window.addEventListener('resize', resizeGPS);
resizeGPS();

function drawGPSPath(distanceKm=1){
  // draw simple winding path length proportional to distance
  const w = gpsCanvas.clientWidth, h = gpsCanvas.clientHeight;
  const steps = Math.max(10, Math.min(80, Math.round(distanceKm*6)));
  gpsCtx.clearRect(0,0,w,h);
  // background grid
  gpsCtx.fillStyle='#f8fafc';
  gpsCtx.fillRect(0,0,w,h);

  let x = 40, y = h/2;
  gpsCtx.lineWidth = 3;
  gpsCtx.strokeStyle = '#0a7cff';
  gpsCtx.beginPath();
  gpsCtx.moveTo(x,y);
  for(let i=0;i<steps;i++){
    x += (w - 80)/steps;
    y += (Math.sin(i*0.8) * (h/2 - 30) * (0.2 + Math.random()*0.8));
    gpsCtx.lineTo(x, Math.max(10, Math.min(h-10,y)));
  }
  gpsCtx.stroke();

  // start & end
  gpsCtx.fillStyle='#10b981';
  gpsCtx.beginPath(); gpsCtx.arc(40, h/2, 6,0,Math.PI*2); gpsCtx.fill();
  gpsCtx.fillStyle='#ef4444';
  gpsCtx.beginPath(); gpsCtx.arc(Math.min(w-20,x), Math.max(10, Math.min(h-10,y)), 6,0,Math.PI*2); gpsCtx.fill();
}

/* save to account if logged in */
const saveRunBtn = document.getElementById('saveRunBtn');
saveRunBtn.addEventListener('click', ()=>{
  if(!currentUser){ alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù„Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨.'); openModal('login'); return; }
  if(!lastCalculation){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªÙŠØ¬Ø© Ù„Ø­ÙØ¸Ù‡Ø§. Ù‚Ù… Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹.'); return; }
  // attach note for diet following
  const note = prompt('Ø£Ø¯Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸Ø© ØªØªØ¹Ù„Ù‚ Ø¨Ø§Ù„Ø­Ù…ÙŠØ© Ø£Ùˆ Ù‡Ø¯Ù Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):', currentUser.notes || '');
  // update user object
  if(!currentUser.runs) currentUser.runs = [];
  currentUser.runs.push({...lastCalculation, note: note || ''});
  currentUser.notes = note || currentUser.notes;
  users[currentUser.email] = currentUser;
  localStorage.setItem('rf_users', JSON.stringify(users));
  localStorage.setItem('rf_user', JSON.stringify(currentUser));
  alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ø­Ø³Ø§Ø¨Ùƒ.');
});

/* clear local history */
const clearLocalBtn = document.getElementById('clearLocalBtn');
clearLocalBtn.addEventListener('click', ()=>{
  if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ (Ø³ÙŠØ¨Ù‚Ù‰ ÙÙŠ Ø­Ø³Ø§Ø¨Ùƒ Ø¥Ø°Ø§ ÙƒÙ†Øª Ù…Ø³Ø¬Ù„Ø§Ù‹)ØŸ')){
    runHistory = [];
    localStorage.setItem('rf_history', JSON.stringify(runHistory));
    renderHistory();
    if(chart) chart.destroy();
    document.getElementById('historyBox').innerHTML = `<div class="small muted">ØªÙ… Ø§Ù„Ù…Ø³Ø­.</div>`;
  }
});

/* helper email validation */
function validateEmail(email){
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

/* initial demo GPS */
drawGPSPath(3);

/* render initial history on load into chart */
renderHistory();
drawChart();

/* expose some functions to console for debugging */
window._rf = { calculate, runHistory, drawGPSPath };

/* ensure responsive canvas scaling on load */
setTimeout(()=>{ resizeGPS(); }, 500);

</script>
</body>
</html>
